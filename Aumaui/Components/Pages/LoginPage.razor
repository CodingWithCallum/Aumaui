@page "/login"
@page "/"
@using AumauiCL.ViewModels
@using Microsoft.FluentUI.AspNetCore.Components
@using Aumaui.Components.Layout
@layout LoginLayout
@inject LoginViewModel ViewModel
@inject NavigationManager Navigation

<PageTitle>Login</PageTitle>

<div class="login-page">
    <div class="login-card">
        
        <div class="header-section">
            <h2 class="login-title">Aumaui</h2>
            <p class="login-subtitle">Welcome back, please sign in.</p>
        </div>

        @if (_currentMode == LoginMode.Selection)
        {
            <div class="view-container">
                <button class="btn-login-option btn-microsoft" @onclick="() => SwitchMode(LoginMode.Microsoft)">
                    <svg width="20" height="20" viewBox="0 0 23 23" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M0 0H10.5556V10.5556H0V0Z" fill="#F25022"/><path d="M12.4444 0H23V10.5556H12.4444V0Z" fill="#7FBA00"/><path d="M0 12.4445H10.5556V23H0V12.4445Z" fill="#00A4EF"/><path d="M12.4444 12.4445H23V23H12.4444V12.4445Z" fill="#FFB900"/></svg>
                    Continue with Microsoft
                </button>

                <button class="btn-login-option btn-xsys" @onclick="() => SwitchMode(LoginMode.Xsys)">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM12 4V12L17.5 15.25L16.5 16.75L10 13V4H12Z" fill="currentColor"/></svg>
                    Sign in with Xsys ID
                </button>
            </div>
        }
        else if (_currentMode == LoginMode.Xsys)
        {
            <div class="view-container slide-in">
                <button class="btn-back" @onclick="GoBack">
                    <span>←</span> Back
                </button>

                <FluentTextField @bind-Value="ViewModel.CompanyCode"
                                 Label="Company Code"
                                 Placeholder="e.g. AUM001"
                                 Required="true"
                                 Style="width: 100%;" />

                <FluentTextField @bind-Value="ViewModel.Email"
                                 Label="Email Address"
                                 Placeholder="name@company.com"
                                 TextFieldType="TextFieldType.Email"
                                 Required="true"
                                 Style="width: 100%;" />

                <FluentTextField @bind-Value="ViewModel.Password"
                                 Label="Password"
                                 TextFieldType="TextFieldType.Password"
                                 Required="true"
                                 Style="width: 100%; margin-bottom: 12px;" />

                <FluentButton Appearance="Appearance.Accent"
                              OnClick="@OnStandardLogin"
                              Disabled="@(!ViewModel.CanLogin || ViewModel.IsBusy)"
                              Style="width: 100%; margin-top: 8px;">
                    @if (ViewModel.IsBusy)
                    {
                        <FluentProgressRing Style="width: 20px; height: 20px;" />
                    }
                    else
                    {
                        <span>Sign In</span>
                    }
                </FluentButton>
            </div>
        }
        else if (_currentMode == LoginMode.Microsoft)
        {
             <div class="view-container slide-in">
                <button class="btn-back" @onclick="GoBack">
                    <span>←</span> Back
                </button>

                <p style="font-size: 0.9rem; margin-bottom: 16px; color: #555;">
                    Please enter your Company Code to verify your organization before continuing to Microsoft.
                </p>

                <FluentTextField @bind-Value="ViewModel.CompanyCode"
                                 Label="Company Code"
                                 Placeholder="e.g. AUM001"
                                 Required="true"
                                 Style="width: 100%; margin-bottom: 24px;" />

                <FluentButton Appearance="Appearance.Accent"
                              OnClick="@OnMicrosoftLogin"
                              Disabled="@(string.IsNullOrWhiteSpace(ViewModel.CompanyCode) || ViewModel.IsBusy)"
                              Style="width: 100%;">
                    @if (ViewModel.IsBusy)
                    {
                        <FluentProgressRing Style="width: 20px; height: 20px;" />
                    }
                    else
                    {
                        <span>Continue to Microsoft</span>
                    }
                </FluentButton>
            </div>
        }

        @if (!string.IsNullOrWhiteSpace(ViewModel.ErrorMessage))
        {
            <div class="slide-in" style="margin-top: 16px;">
                 <FluentMessageBar Intent="MessageIntent.Error"
                                  AllowDismiss="true"
                                  OnDismiss="@(() => ViewModel.ErrorMessage = string.Empty)">
                    @ViewModel.ErrorMessage
                </FluentMessageBar>
            </div>
        }
    </div>
</div>

@code {
    private enum LoginMode { Selection, Xsys, Microsoft }
    private LoginMode _currentMode = LoginMode.Selection;

    private void SwitchMode(LoginMode mode)
    {
        _currentMode = mode;
        ViewModel.ErrorMessage = string.Empty; // Clear errors on mode switch
    }

    private void GoBack()
    {
        _currentMode = LoginMode.Selection;
        ViewModel.ErrorMessage = string.Empty;
    }

    private async Task OnMicrosoftLogin()
    {
        await ViewModel.LoginWithMicrosoftCommand.ExecuteAsync(null);

        if (string.IsNullOrEmpty(ViewModel.ErrorMessage))
        {
            Navigation.NavigateTo("/sync");
        }
    }

    private async Task OnStandardLogin()
    {
        await ViewModel.LoginWithStandardCommand.ExecuteAsync(null);
        
        if (string.IsNullOrEmpty(ViewModel.ErrorMessage))
        {
            Navigation.NavigateTo("/sync");
        }
    }
}
